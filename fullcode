import chromadb
from ollama import Client, chat, ChatResponse
import random
import time
from datetime import datetime, timedelta
import json
from typing import Optional, Dict, Any, List
from typing import Literal # Used for cleaner type hinting

COLLECTION_NAME = "api_performance_v5"
DB_PATH = "./chroma_db_performance_v5"
OLLAMA_HOST = 'http://localhost:11434'
OLLAMA_MODEL = 'llama3.1'  # Use your specific Llama 3 model tag
NUM_RECORDS = 5000
API_LIST = ["POST /login", "GET /userProfile", "POST /submitOrder", "GET /productDetails"]
FUNCTIONALITY_LIST = ["Authentication", "UserManagement", "OrderProcessing", "Catalog"]
RelativePeriod = Literal['TODAY', 'YESTERDAY', 'LAST_7_DAYS', 'LAST_30_DAYS', 'LAST_MONTH']

def generate_synthetic_data(count):
    records = []

    for i in range(1, count + 1):
        api = random.choice(API_LIST)
        func = FUNCTIONALITY_LIST[API_LIST.index(api)]

        # Numeric Fields (Simulating different data across last 60 days)
        total = random.randint(100, 2000)
        failed = random.choices([0, 1, 5, 20, 100], weights=[60, 15, 10, 8, 7])[0]
        avg_time = random.uniform(2000.0, 5000.0) if failed >= 20 else random.uniform(50.0, 800.0)

        start_date = datetime.now() - timedelta(days=60)
        execution_time = start_date + timedelta(seconds=random.randint(0, 60 * 24 * 60 * 60))

        metadata = {
            "functionality": func,
            "api": api,
            "total": total,
            "passed": total - failed,
            "failed": failed,
            "averagetimetaken": round(avg_time, 2),
            "datetime": execution_time.isoformat(),
            "datetime_epoch": int(execution_time.timestamp()),  # Numeric for filtering
        }

        records.append({
            "id": f"run_{i}",
            "document": f"Performance metrics for {func} suite, {api} endpoint. Status: {'Critical' if failed > 20 else 'Normal'}.",
            "metadata": metadata
        })
    file_path = "my_list_data.json"

    with open(file_path, 'w', encoding='utf-8') as json_file:
        json.dump(records, json_file, indent=4, ensure_ascii=False)

    print(f"List saved to {file_path}")
    return records


def index_data(records: List[Dict]):
    print(f"Initializing ChromaDB at {DB_PATH}...")
    client = chromadb.PersistentClient(path=DB_PATH)
    try:
        client.delete_collection(name=COLLECTION_NAME)
    except Exception:
        pass

    collection = client.get_or_create_collection(name=COLLECTION_NAME)

    collection.add(
        documents=[r["document"] for r in records],
        metadatas=[r["metadata"] for r in records],
        ids=[r["id"] for r in records],
    )
    print(f"Indexing complete. Total records: {collection.count()}")


if __name__ == "__main__":
    synthetic_data = generate_synthetic_data(NUM_RECORDS)
    index_data(synthetic_data)
