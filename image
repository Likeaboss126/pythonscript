# Weekly Trend Indicators Section

st.subheader("ğŸ“ˆ Weekly Trend Indicators")

# Use all APIs of the selected functionalities (ignore API filter)
df_func_filtered = df[df['Functionality'].isin(selected_funcs)].copy()

# Extract week number
df_func_filtered['Week'] = pd.to_datetime(df_func_filtered['DateTime']).dt.isocalendar().week

# Get latest two weeks
latest_weeks = sorted(df_func_filtered['Week'].unique())
if len(latest_weeks) >= 2:
    week1, week2 = latest_weeks[-2], latest_weeks[-1]

    df_w1 = df_func_filtered[df_func_filtered['Week'] == week1]
    df_w2 = df_func_filtered[df_func_filtered['Week'] == week2]

    # Aggregate average response per API per functionality
    agg_w1 = df_w1.groupby(['Functionality', 'API'])['Averagetimetaken'].mean().reset_index(name='Avg_Week1')
    agg_w2 = df_w2.groupby(['Functionality', 'API'])['Averagetimetaken'].mean().reset_index(name='Avg_Week2')

    # Merge
    merged = pd.merge(agg_w1, agg_w2, on=['Functionality', 'API'])
    merged['Change %'] = ((merged['Avg_Week2'] - merged['Avg_Week1']) / merged['Avg_Week1']) * 100

    # Keep only Â±2% changes
    merged = merged[merged['Change %'].abs() >= 2]

    # Add colored arrows
    def trend(row):
        if row['Change %'] > 0:
            return f"ğŸ”´â¬‡ï¸ Degraded by {abs(row['Change %']):.2f}%"
        else:
            return f"ğŸŸ¢â¬†ï¸ Improved by {abs(row['Change %']):.2f}%"

    merged['Trend'] = merged.apply(trend, axis=1)

    st.dataframe(merged[['Functionality', 'API', 'Avg_Week1', 'Avg_Week2', 'Trend']], use_container_width=True)
else:
    st.info("Not enough weekly data for comparison.")
