import streamlit as st
import sqlite3
import pandas as pd
import subprocess

DB_PATH = "health.db"

def get_latest_app_status():
    query = '''
        WITH latest_runs AS (
            SELECT ApplicationName, MAX(DateTime) AS MaxDateTime
            FROM health_status
            GROUP BY ApplicationName
        ),
        latest_data AS (
            SELECT hs.*
            FROM health_status hs
            JOIN latest_runs lr
            ON hs.ApplicationName = lr.ApplicationName AND hs.DateTime = lr.MaxDateTime
        )
        SELECT *
        FROM latest_data
        ORDER BY ApplicationName, DateTime
    '''
    df = pd.read_sql_query(query, conn)
    conn.close()

    df.columns = [col.strip() for col in df.columns]

    status_rows = []
    for app, group in df.groupby("Functionality"):
        failed_apis_df = group[(group["OK"] == 0) & (group["KO"] > 0)]

        if not failed_apis_df.empty:
            error_msg = "; ".join(
                f"{row['APIS']}: {row['Error']}" for _, row in failed_apis_df.iterrows()
            )
            status = f"âŒ Failed - {error_msg}"
        else:
            error_msg = ""
            status = "âœ… Passed"

        status_rows.append({
            "Functionality": app,
            "DateTime": group["DateTime"].max(),
            "OK": group["OK"].sum(),
            "KO": group["KO"].sum(),
            "Error": error_msg,
            "Status": status
        })

    result_df = pd.DataFrame(status_rows)
    return result_df["Functionality"].tolist(), result_df

def run_health_check_script():
    subprocess.run(["python", "health_checker.py"])

# Streamlit App
st.set_page_config(page_title="API Health Dashboard", layout="wide")
st.title("ğŸ©º Application Health Checker")

if st.button("ğŸ”„ Run Health Check Now"):
    st.info("Running health check script...")
    run_health_check_script()
    st.success("Done!")

df = get_latest_app_status()

if not df.empty:
    st.subheader("ğŸ“Š Latest Health Check Summary")
    st.dataframe(df, use_container_width=True)
else:
    st.warning("No data found. Run the check to populate data.")
