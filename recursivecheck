import requests
import time
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://<domain>.atlassian.net/wiki"
TOKEN = "YOUR_BEARER_TOKEN"
SPACE_KEY = "ABCD"
PARENT_TITLE = "My Parent Page"

headers = {
    "Accept": "application/json",
    "Authorization": f"Bearer {TOKEN}"
}

def safe_get(url, params=None):
    while True:
        r = requests.get(url, headers=headers, params=params, verify=False)

        if r.status_code == 429:
            retry = int(r.headers.get("Retry-After", "5"))
            print(f"â³ Sleeping {retry}s due to rate limit")
            time.sleep(retry)
            continue

        r.raise_for_status()
        return r.json()

# 1ï¸âƒ£ Get small list of pages in space (cheap)
def get_pages_in_space():
    url = f"{BASE_URL}/rest/api/content"
    params = {
        "spaceKey": SPACE_KEY,
        "limit": 10,
        "expand": "ancestors"
    }
    return safe_get(url, params)["results"]

# 2ï¸âƒ£ Find parent + children locally
def find_parent_and_children(pages):
    parent_id = None
    children = []

    for p in pages:
        if p["title"] == PARENT_TITLE:
            parent_id = p["id"]
            break

    if not parent_id:
        raise Exception("Parent page not found")

    for p in pages:
        if p.get("ancestors"):
            if p["ancestors"][-1]["id"] == parent_id:
                children.append(p)

    return parent_id, children

# 3ï¸âƒ£ Fetch body only for specific pages (slow + safe)
def get_page_body(page_id):
    url = f"{BASE_URL}/rest/api/content/{page_id}"
    params = {"expand": "body.storage"}
    data = safe_get(url, params)
    time.sleep(2)  # prevent 429
    return data["title"], data["body"]["storage"]["value"]

# ---- MAIN ----
pages = get_pages_in_space()
parent_id, children = find_parent_and_children(pages)

print(f"ğŸ“„ Parent ID: {parent_id}")
print("ğŸ“‚ Children IDs:", [c["id"] for c in children])

# Fetch content (only few pages â†’ safe)
print("\nğŸ“– Reading content...\n")

title, body = get_page_body(parent_id)
print("PARENT:", title)

for c in children:
    title, body = get_page_body(c["id"])
    print("CHILD:", title)
