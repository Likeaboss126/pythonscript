import requests
import time
from requests.auth import HTTPBasicAuth

BASE_URL = "https://<domain>.atlassian.net/wiki"
EMAIL = "your-email@domain.com"
API_TOKEN = "your_api_token"

auth = HTTPBasicAuth(EMAIL, API_TOKEN)
headers = {
    "Accept": "application/json"
}

# ---- rate limit safe request ----
def safe_get(url, params=None):
    while True:
        response = requests.get(url, headers=headers, auth=auth, params=params)
        if response.status_code == 429:
            retry_after = int(response.headers.get("Retry-After", "5"))
            print(f"Rate limited. Sleeping {retry_after} sec...")
            time.sleep(retry_after)
        else:
            response.raise_for_status()
            return response.json()

# ---- get page by title ----
def get_page_by_title(space_key, title):
    url = f"{BASE_URL}/rest/api/content"
    params = {
        "spaceKey": space_key,
        "title": title,
        "expand": "version"
    }
    data = safe_get(url, params)
    if data["size"] == 0:
        raise Exception("Page not found")
    return data["results"][0]["id"]

# ---- get page body ----
def get_page_body(page_id):
    url = f"{BASE_URL}/rest/api/content/{page_id}"
    params = {
        "expand": "body.storage"
    }
    data = safe_get(url, params)
    return data["title"], data["body"]["storage"]["value"]

# ---- get child pages ----
def get_child_pages(page_id):
    url = f"{BASE_URL}/rest/api/content/{page_id}/child/page"
    children = []
    start = 0

    while True:
        params = {"limit": 25, "start": start}
        data = safe_get(url, params)
        children.extend(data["results"])

        if data["_links"].get("next"):
            start += 25
        else:
            break

    return children

# ---- recursive traversal ----
def traverse_page(page_id, depth=0):
    title, body = get_page_body(page_id)

    print("  " * depth + f"ðŸ“„ {title}")

    # Optional: process body here
    # print(body[:200])

    time.sleep(2)  # prevent 429 (important)

    children = get_child_pages(page_id)

    for child in children:
        traverse_page(child["id"], depth + 1)

# ---- main ----
if __name__ == "__main__":
    SPACE_KEY = "ABC"
    PAGE_TITLE = "MyPageTitle"

    root_page_id = get_page_by_title(SPACE_KEY, PAGE_TITLE)
    traverse_page(root_page_id)
