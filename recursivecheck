import requests
import time
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://<domain>.atlassian.net/wiki"
TOKEN = "YOUR_BEARER_TOKEN"
SPACE_KEY = "ABCD"
PARENT_TITLE = "My Parent Page"

headers = {
    "Accept": "application/json",
    "Authorization": f"Bearer {TOKEN}"
}

# ---------- Safe GET with 429 handling ----------
def safe_get(url, params=None):
    while True:
        r = requests.get(url, headers=headers, params=params, verify=False)

        if r.status_code == 429:
            retry = int(r.headers.get("Retry-After", "5"))
            print(f"â³ Rate limited. Sleeping {retry}s")
            time.sleep(retry)
            continue

        r.raise_for_status()
        return r.json()

# ---------- 1ï¸âƒ£ Get parent page ID by title (cheap) ----------
def get_parent_page_id():
    url = f"{BASE_URL}/rest/api/content"
    params = {
        "spaceKey": SPACE_KEY,
        "title": PARENT_TITLE,
        "limit": 1
    }

    data = safe_get(url, params)

    if data["size"] == 0:
        raise Exception(f"âŒ Parent page '{PARENT_TITLE}' not found in space '{SPACE_KEY}'")

    parent_id = data["results"][0]["id"]
    print(f"ğŸ“„ Parent ID: {parent_id}")
    return parent_id

# ---------- 2ï¸âƒ£ Get small list of pages in space (cheap) ----------
def get_pages_in_space():
    url = f"{BASE_URL}/rest/api/content"
    params = {
        "spaceKey": SPACE_KEY,
        "limit": 25,
        "expand": "ancestors"   # needed to detect parent-child locally
    }

    data = safe_get(url, params)
    return data["results"]

# ---------- 3ï¸âƒ£ Find children locally using ancestors ----------
def find_children(pages, parent_id):
    children = []

    for p in pages:
        if p.get("ancestors"):
            if p["ancestors"][-1]["id"] == parent_id:
                children.append(p)

    print(f"ğŸ“‚ Found {len(children)} child pages")
    return children

# ---------- 4ï¸âƒ£ Fetch page body (heavy â†’ add delay) ----------
def get_page_body(page_id):
    url = f"{BASE_URL}/rest/api/content/{page_id}"
    params = {"expand": "body.storage"}

    data = safe_get(url, params)
    time.sleep(2)  # ğŸ”¥ prevent 429

    return data["title"], data["body"]["storage"]["value"]

# ---------- MAIN ----------
if __name__ == "__main__":
    print("ğŸ” Finding parent page...")
    parent_id = get_parent_page_id()

    print("ğŸ“¥ Fetching small space page list...")
    pages = get_pages_in_space()

    children = find_children(pages, parent_id)

    print("\nğŸ“– Reading content (parent + children)...\n")

    # Parent content
    title, body = get_page_body(parent_id)
    print("PARENT:", title)

    # Children content
    for c in children:
        title, body = get_page_body(c["id"])
        print("CHILD:", title)

    print("\nâœ… Done.")


f"{BASE_URL}/rest/api/content"
        f"?spaceKey={SPACE_KEY}&title={encoded_title}&limit=1"
