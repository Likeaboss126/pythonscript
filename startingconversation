import streamlit as st
import requests
import json

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL_NAME = "phi3:mini"

# ---------------- CSS FOR BIGGER CHAT TEXT ---------------- #
st.markdown("""
<style>
.chat-message {
    font-size: 18px !important;
}
</style>
""", unsafe_allow_html=True)

# ---------------- SESSION STATE ---------------- #
if "user_data" not in st.session_state:
    st.session_state.user_data = {
        "age": None,
        "monthly_income": None,
        "monthly_expenses": None,
        "risk_profile": None,
        "goals": []
    }

if "stage" not in st.session_state:
    st.session_state.stage = "welcome"

if "awaiting_goal_confirmation" not in st.session_state:
    st.session_state.awaiting_goal_confirmation = False

if "messages" not in st.session_state:
    st.session_state.messages = []

# ---------------- AI GOAL EXTRACTION ---------------- #
def ai_extract_goal(user_text):
    prompt = f"""
You are an information extraction system.

Extract a financial goal from the user input.

Return ONLY valid JSON in this exact format:
{{
  "name": "<goal name>",
  "target_year": <year>,
  "target_amount": <number>
}}

Rules:
- target_year must be a 4 digit year
- target_amount must be a number without commas
- Do not include any text outside JSON

Examples:

Input: Child education 230000 in 2030
Output:
{{"name":"Child education","target_year":2030,"target_amount":230000}}

Input: Vacation 3 lakh in 2028
Output:
{{"name":"Vacation","target_year":2028,"target_amount":300000}}

User input:
{user_text}
"""
    payload = {
        "model": MODEL_NAME,
        "prompt": prompt,
        "stream": False,
        "options": {"temperature": 0}
    }

    response = requests.post(OLLAMA_URL, json=payload)
    data = response.json()["response"]

    try:
        return json.loads(data)
    except:
        return None

# ---------------- HELPER ---------------- #
def bot_says(text):
    st.session_state.messages.append({"role": "assistant", "content": text})

# ---------------- HANDLE USER INPUT FIRST ---------------- #
user_input = st.chat_input("Type your answer here...")

if user_input:
    st.session_state.messages.append({"role": "user", "content": user_input})

    # ---- AGE ---- #
    if st.session_state.stage == "age":
        st.session_state.user_data["age"] = int(user_input)
        bot_says("ğŸ’° What is your monthly income?")
        st.session_state.stage = "income"

    # ---- INCOME ---- #
    elif st.session_state.stage == "income":
        st.session_state.user_data["monthly_income"] = int(user_input)
        bot_says("ğŸ§¾ What are your monthly expenses?")
        st.session_state.stage = "expenses"

    # ---- EXPENSES ---- #
    elif st.session_state.stage == "expenses":
        st.session_state.user_data["monthly_expenses"] = int(user_input)
        bot_says("ğŸ“Š What is your risk profile? (Conservative / Moderate / Aggressive)")
        st.session_state.stage = "risk"

    # ---- RISK ---- #
    elif st.session_state.stage == "risk":
        st.session_state.user_data["risk_profile"] = user_input.capitalize()
        bot_says("ğŸ¯ Tell me your financial goal with amount and year (e.g., Child education 150000 in 2029)")
        st.session_state.stage = "goal"

    # ---- GOAL INPUT ---- #
    elif st.session_state.stage == "goal":
        goal = ai_extract_goal(user_input)

        if goal:
            st.session_state.user_data["goals"].append(goal)
            bot_says("â• Do you want to add another goal? (yes/no)")
            st.session_state.awaiting_goal_confirmation = True
        else:
            bot_says("âš ï¸ I couldnâ€™t understand the goal. Please try again.")

    # ---- GOAL CONFIRMATION ---- #
    elif st.session_state.awaiting_goal_confirmation:
        if user_input.lower() in ["yes", "y"]:
            bot_says("ğŸ¯ Please enter your next goal.")
            st.session_state.stage = "goal"
            st.session_state.awaiting_goal_confirmation = False
        else:
            st.session_state.awaiting_goal_confirmation = False
            st.session_state.stage = "complete"
            bot_says("âœ… All data collected! Here is your profile:")
            bot_says(f"```json\n{json.dumps(st.session_state.user_data, indent=2)}\n```")

# ---------------- WELCOME MESSAGE ---------------- #
if st.session_state.stage == "welcome":
    bot_says("ğŸ‘‹ **Hi! Iâ€™m your AI Financial Advisor**")
    bot_says("Iâ€™ll help you create a goal-based financial plan ğŸ“Š")
    bot_says("ğŸ‚ What is your age?")
    st.session_state.stage = "age"

# ---------------- DISPLAY CHAT ---------------- #
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(f"<div class='chat-message'>{msg['content']}</div>", unsafe_allow_html=True)




import re

def fallback_goal_parser(text):
    year_match = re.search(r"(20\d{2})", text)
    amount_match = re.search(r"(\d+)", text)

    if year_match and amount_match:
        year = int(year_match.group(1))
        amount = int(amount_match.group(1))

        name = re.sub(r"\d+.*", "", text).strip()

        return {
            "name": name if name else "Goal",
            "target_year": year,
            "target_amount": amount
        }

    return None



goal = ai_extract_goal(user_input)

if not goal:
    goal = fallback_goal_parser(user_input)

if goal:
    st.session_state.user_data["goals"].append(goal)
    bot_says("â• Do you want to add another goal? (yes/no)")
    st.session_state.awaiting_goal_confirmation = True
else:
    bot_says("âš ï¸ Please enter goal like: Child education 150000 in 2029")







You are a financial advisor.

Explain the financial plan in simple, friendly language.

You will be given:
- riskProfile
- expectedAnnualReturn (CAGR)
- expectedAnnualVolatility
- recommendedAssetAllocation (percentages)
- goals (with status)
- remainingRetirement (final retirement corpus at age 60)

Explain in this order:
1. What the risk profile means
2. How the money is allocated across asset classes
3. What the expected annual return (CAGR) means for long-term growth
4. What volatility means in simple terms
5. Whether each goal is on track or has a shortfall
6. The retirement corpus available at age 60

Rules:
- Do NOT add new numbers
- Do NOT change any values
- Do NOT show formulas
- Keep the explanation concise and easy to understand
"""



â€œThe system computes all projections deterministically and uses AI only to generate a user-friendly explanation of allocation, goals, risk, and retirement outcomes.â€




import time

if st.button("ğŸ“Š Generate Financial Plan"):

    loading_placeholder = st.empty()

    with loading_placeholder.chat_message("assistant"):

        status_text = st.empty()
        progress = st.progress(0)

        # ğŸ”¹ Stage animation BEFORE LLM call
        status_text.markdown("ğŸ¤– Analysing your finances...")
        progress.progress(20)
        time.sleep(0.3)

        status_text.markdown("ğŸ“Š Evaluating asset allocation...")
        progress.progress(40)
        time.sleep(0.3)

        status_text.markdown("ğŸ¯ Checking goals & retirement...")
        progress.progress(60)
        time.sleep(0.3)

        # ğŸ”¹ LLM thinking phase
        status_text.markdown("ğŸ§  AI is preparing your personalised plan...")
        progress.progress(75)

        # ğŸ”¥ Actual blocking LLM call
        explanation = generate_full_plan_explanation(plan_json)

        # ğŸ”¹ Final state
        progress.progress(100)
        status_text.markdown("âœ… Plan ready!")

    loading_placeholder.empty()

    st.session_state.messages.append({
        "role": "assistant",
        "content": explanation
    })

    st.rerun()



bot_says("ğŸ“Š Generating your personalised financial plan...")

st.session_state.loading = True
st.session_state.stage = "analysing"

st.rerun()




if st.session_state.get("loading", False):

    explanation = generate_full_plan_explanation(plan_json)

    # Replace last loader message with final explanation
    st.session_state.messages[-1] = {
        "role": "assistant",
        "content": explanation
    }

    st.session_state.loading = False
    st.session_state.stage = "done"

    st.rerun()



bot_says("ğŸ“¦ Here is your collected profile:")
bot_says(json.dumps(st.session_state.user_data, indent=2))

bot_says("ğŸ“Š Generating your personalised financial plan...")

st.session_state.stage = "ready_for_analysis"
st.rerun()


if st.session_state.stage == "ready_for_analysis":

    st.session_state.loading = True
    st.session_state.stage = "analysing"
    st.rerun()



