import streamlit as st
import requests
import json

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL_NAME = "phi3:mini"  # change if needed

# ---------------- SESSION STATE ---------------- #
if "user_data" not in st.session_state:
    st.session_state.user_data = {
        "age": None,
        "monthly_income": None,
        "monthly_expenses": None,
        "risk_profile": None,
        "goals": []
    }

if "stage" not in st.session_state:
    st.session_state.stage = "welcome"

if "awaiting_goal_confirmation" not in st.session_state:
    st.session_state.awaiting_goal_confirmation = False

# ---------------- AI GOAL EXTRACTION ---------------- #
def ai_extract_goal(user_text):
    prompt = f"""
Extract financial goal details.

Return ONLY valid JSON with:
name, target_year, target_amount

User input:
{user_text}
"""

    payload = {
        "model": MODEL_NAME,
        "prompt": prompt,
        "stream": False,
        "options": {"temperature": 0}
    }

    response = requests.post(OLLAMA_URL, json=payload)
    data = response.json()["response"]

    try:
        return json.loads(data)
    except:
        return None

# ---------------- UI ---------------- #
st.title("ğŸ’¼ AI Financial Advisor")

# Welcome message
if st.session_state.stage == "welcome":
    st.markdown("""
ğŸ‘‹ **Hi! Iâ€™m your AI Financial Advisor**  
Iâ€™ll help you create a goal-based financial plan ğŸ“Š  

Letâ€™s start with a few quick details.
""")
    st.session_state.stage = "age"

user_input = st.text_input("âœï¸ Your response")

# ---------------- LOGIC ---------------- #
if user_input:

    # ---- AGE ---- #
    if st.session_state.stage == "age":
        st.session_state.user_data["age"] = int(user_input)
        st.session_state.stage = "income"

    # ---- INCOME ---- #
    elif st.session_state.stage == "income":
        st.session_state.user_data["monthly_income"] = int(user_input)
        st.session_state.stage = "expenses"

    # ---- EXPENSES ---- #
    elif st.session_state.stage == "expenses":
        st.session_state.user_data["monthly_expenses"] = int(user_input)
        st.session_state.stage = "risk"

    # ---- RISK PROFILE ---- #
    elif st.session_state.stage == "risk":
        st.session_state.user_data["risk_profile"] = user_input.capitalize()
        st.session_state.stage = "goal"

    # ---- GOAL INPUT ---- #
    elif st.session_state.stage == "goal":
        goal = ai_extract_goal(user_input)

        if goal:
            st.session_state.user_data["goals"].append(goal)
            st.session_state.awaiting_goal_confirmation = True
        else:
            st.warning("âš ï¸ I couldnâ€™t understand the goal. Please try again.")

    # ---- GOAL CONFIRMATION ---- #
    elif st.session_state.awaiting_goal_confirmation:
        if user_input.lower() in ["yes", "y"]:
            st.session_state.awaiting_goal_confirmation = False
            st.session_state.stage = "goal"
        else:
            st.session_state.awaiting_goal_confirmation = False
            st.session_state.stage = "complete"

# ---------------- PROMPTS ---------------- #
if st.session_state.stage == "age":
    st.write("ğŸ‚ What is your age?")

elif st.session_state.stage == "income":
    st.write("ğŸ’° What is your monthly income?")

elif st.session_state.stage == "expenses":
    st.write("ğŸ§¾ What are your monthly expenses?")

elif st.session_state.stage == "risk":
    st.write("ğŸ“Š What is your risk profile? (Conservative / Moderate / Aggressive)")

elif st.session_state.stage == "goal":
    st.write("ğŸ¯ Tell me your financial goal with amount and year (e.g., Child education 150000 in 2029)")

elif st.session_state.awaiting_goal_confirmation:
    st.write("â• Do you want to add another goal? (yes/no)")

elif st.session_state.stage == "complete":
    st.success("âœ… All data collected! Here is your profile:")
    st.json(st.session_state.user_data)
