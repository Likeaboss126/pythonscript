import streamlit as st
import requests
import json

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL_NAME = "phi3:mini"

# ---------------- CSS FOR BIGGER CHAT TEXT ---------------- #
st.markdown("""
<style>
.chat-message {
    font-size: 18px !important;
}
</style>
""", unsafe_allow_html=True)

# ---------------- SESSION STATE ---------------- #
if "user_data" not in st.session_state:
    st.session_state.user_data = {
        "age": None,
        "monthly_income": None,
        "monthly_expenses": None,
        "risk_profile": None,
        "goals": []
    }

if "stage" not in st.session_state:
    st.session_state.stage = "welcome"

if "awaiting_goal_confirmation" not in st.session_state:
    st.session_state.awaiting_goal_confirmation = False

if "messages" not in st.session_state:
    st.session_state.messages = []

# ---------------- AI GOAL EXTRACTION ---------------- #
def ai_extract_goal(user_text):
    prompt = f"""
Extract financial goal details.

Return ONLY valid JSON with:
name, target_year, target_amount

User input:
{user_text}
"""
    payload = {
        "model": MODEL_NAME,
        "prompt": prompt,
        "stream": False,
        "options": {"temperature": 0}
    }

    response = requests.post(OLLAMA_URL, json=payload)
    data = response.json()["response"]

    try:
        return json.loads(data)
    except:
        return None

# ---------------- HELPER ---------------- #
def bot_says(text):
    st.session_state.messages.append({"role": "assistant", "content": text})

# ---------------- HANDLE USER INPUT FIRST ---------------- #
user_input = st.chat_input("Type your answer here...")

if user_input:
    st.session_state.messages.append({"role": "user", "content": user_input})

    # ---- AGE ---- #
    if st.session_state.stage == "age":
        st.session_state.user_data["age"] = int(user_input)
        bot_says("ğŸ’° What is your monthly income?")
        st.session_state.stage = "income"

    # ---- INCOME ---- #
    elif st.session_state.stage == "income":
        st.session_state.user_data["monthly_income"] = int(user_input)
        bot_says("ğŸ§¾ What are your monthly expenses?")
        st.session_state.stage = "expenses"

    # ---- EXPENSES ---- #
    elif st.session_state.stage == "expenses":
        st.session_state.user_data["monthly_expenses"] = int(user_input)
        bot_says("ğŸ“Š What is your risk profile? (Conservative / Moderate / Aggressive)")
        st.session_state.stage = "risk"

    # ---- RISK ---- #
    elif st.session_state.stage == "risk":
        st.session_state.user_data["risk_profile"] = user_input.capitalize()
        bot_says("ğŸ¯ Tell me your financial goal with amount and year (e.g., Child education 150000 in 2029)")
        st.session_state.stage = "goal"

    # ---- GOAL INPUT ---- #
    elif st.session_state.stage == "goal":
        goal = ai_extract_goal(user_input)

        if goal:
            st.session_state.user_data["goals"].append(goal)
            bot_says("â• Do you want to add another goal? (yes/no)")
            st.session_state.awaiting_goal_confirmation = True
        else:
            bot_says("âš ï¸ I couldnâ€™t understand the goal. Please try again.")

    # ---- GOAL CONFIRMATION ---- #
    elif st.session_state.awaiting_goal_confirmation:
        if user_input.lower() in ["yes", "y"]:
            bot_says("ğŸ¯ Please enter your next goal.")
            st.session_state.stage = "goal"
            st.session_state.awaiting_goal_confirmation = False
        else:
            st.session_state.awaiting_goal_confirmation = False
            st.session_state.stage = "complete"
            bot_says("âœ… All data collected! Here is your profile:")
            bot_says(f"```json\n{json.dumps(st.session_state.user_data, indent=2)}\n```")

# ---------------- WELCOME MESSAGE ---------------- #
if st.session_state.stage == "welcome":
    bot_says("ğŸ‘‹ **Hi! Iâ€™m your AI Financial Advisor**")
    bot_says("Iâ€™ll help you create a goal-based financial plan ğŸ“Š")
    bot_says("ğŸ‚ What is your age?")
    st.session_state.stage = "age"

# ---------------- DISPLAY CHAT ---------------- #
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(f"<div class='chat-message'>{msg['content']}</div>", unsafe_allow_html=True)
