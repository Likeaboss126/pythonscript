# Modelfile
# 1. Source: Points to your single, merged GGUF file
FROM ./merged_phi3_4k.gguf

# 2. PARAMETERS (Essential)
PARAMETER num_ctx 4096
PARAMETER stop <|end|>
PARAMETER stop <|user|>
PARAMETER stop <|assistant|>
PARAMETER stop <|tool_response|>

# 3. TEMPLATE (CRITICAL FIX for Instruct/Tooling)
# This forces the template that Phi-3 was trained on for instruction and tool use.
TEMPLATE """
{{- if .System }}<|system|>{{ .System }}<|end|>{{- endif -}}
{{- if .ToolCalls -}}
  <|tool_calls|>
  {{- range .ToolCalls -}}
    {{- if .ID }}
      <|tool_call_id|>{{ .ID }}<|end|>
    {{- else }}
      <|tool_call|>
      {"name":"{{ .Name }}", "arguments":{{ .Arguments }}}
      <|end|>
    {{- end -}}
  {{- end -}}
  <|end|>
{{- end -}}
<|user|>{{ .Prompt }}<|end|>
{{- if .Response }}
<|assistant|>{{ .Response }}<|end|>
{{- end }}
"""
